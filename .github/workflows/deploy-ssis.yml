name: SSIS Deployment to SSISDB Catalog

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-ssis:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify SSISDB Access
        shell: powershell
        run: |
          $sqlServer = "LAPTOP-7LSAQSR0"
          
          # Test connection to SSISDB catalog
          try {
              $result = sqlcmd -S $sqlServer -d "SSISDB" -Q "SELECT 1 FROM catalog.folders" -E -h -1 -W
              if ($LASTEXITCODE -ne 0) {
                  throw "Failed to query SSISDB catalog"
              }
              Write-Host "Successfully connected to SSISDB catalog using Windows Authentication"
          } catch {
              Write-Error "SSISDB catalog access failed: $_"
              Write-Host "Troubleshooting Steps:"
              Write-Host "1. Verify SQL Server is running and accessible"
              Write-Host "2. Confirm the runner service account has permissions to SSISDB"
              Write-Host "3. Check if Windows Authentication is enabled on SQL Server"
              exit 1
          }

      - name: Ensure Timesheet Folder Exists
        shell: powershell
        run: |
          $sqlServer = "LAPTOP-7LSAQSR0"
          $folderName = "TimesheetFolder"
          
          try {
              # Check if folder exists in SSISDB catalog
              $exists = sqlcmd -S $sqlServer -d "SSISDB" -Q "IF EXISTS (SELECT 1 FROM catalog.folders WHERE name = '$folderName') SELECT 1 ELSE SELECT 0" -E -h -1 -W
              
              if ($exists -eq "0") {
                  Write-Host "Creating folder '$folderName' in SSISDB catalog..."
                  sqlcmd -S $sqlServer -d "SSISDB" -Q "EXEC catalog.create_folder @folder_name = '$folderName'" -E
                  Write-Host "Folder created successfully in SSISDB catalog"
              } else {
                  Write-Host "Folder '$folderName' already exists in SSISDB catalog"
              }
          } catch {
              Write-Error "Failed to create folder in SSISDB catalog: $_"
              exit 1
          }

      - name: Deploy Packages to SSISDB
        shell: powershell
        run: |
          $packagePath = "$env:GITHUB_WORKSPACE\HandsOnProjects\Timesheet\TimesheetMigrationProject"
          $catalogServer = "LAPTOP-7LSAQSR0"
          $folderName = "TimesheetFolder"
          
          if (-not (Test-Path $packagePath)) {
              Write-Error "SSIS project path not found: $packagePath"
              exit 1
          }
          
          # Deploy each package to SSISDB catalog
          Get-ChildItem -Path $packagePath -Filter *.dtsx | ForEach-Object {
              $packageName = $_.BaseName
              Write-Host "Deploying package '$packageName' to SSISDB catalog..."
              
              & "C:\SSISDevOpsTools\SSISDeploy.exe" `
                  -source:"$($_.FullName)" `
                  -destination:"catalog;/SSISDB/$folderName/$packageName;$catalogServer" `
                  -authType:"winAuth" `
                  -log:"DIAG;$env:GITHUB_WORKSPACE\ssis-deploy-$packageName.log"
              
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Failed to deploy package '$packageName' to SSISDB catalog"
                  Get-Content "$env:GITHUB_WORKSPACE\ssis-deploy-$packageName.log" | Write-Host
                  exit $LASTEXITCODE
              }
              
              Write-Host "Successfully deployed package '$packageName' to SSISDB catalog"
          }
