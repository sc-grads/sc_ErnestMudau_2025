name: SSIS Deployment Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'HandsOnProjects/Timesheet/TimesheetMigrationProject/**'

jobs:
  deploy-ssis:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Restore NuGet packages
      run: nuget restore HandsOnProjects/Timesheet/TimesheetMigrationProject/TimesheetMigrationProject.sln

    - name: Build SSIS project
      run: msbuild HandsOnProjects/Timesheet/TimesheetMigrationProject/TimesheetMigrationProject.sln /p:Configuration=Release /p:Platform="Any CPU"

    - name: Deploy SSIS packages
      run: |
        $packagePath = "HandsOnProjects/Timesheet/TimesheetMigrationProject"
        $serverName = "${{ secrets.SQL_SERVER_NAME }}"
        $folderName = "${{ secrets.SSIS_FOLDER_NAME || 'TimesheetFolder' }}"
        
        # Deploy each DTSX package found in the project
        Get-ChildItem -Path $packagePath -Filter *.dtsx -Recurse | ForEach-Object {
            $packageName = $_.BaseName
            Write-Output "Deploying package $packageName to \SSISDB\$folderName on $serverName"
            
            & "C:\SSISDevOpsTools\SSISDeploy.exe" `
              -source:$_.FullName `
              -destination:"CATALOG;/SSISDB/$folderName/$packageName;$serverName" `
              -authType:"winAuth" `
              -log:"DIAG;C:\SSISDeployLogs\$packageName.log"
            
            if ($LASTEXITCODE -ne 0) {
                Write-Error "Failed to deploy package $packageName. Exit code: $LASTEXITCODE"
                exit $LASTEXITCODE
            }
            
            Write-Output "Successfully deployed package $packageName"
        }
