name: Deploy SSIS Packages to File System

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-ssis:
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify SSISDeploy.exe Exists
        run: |
          $ssisDeployPath = "C:\SSISDevOpsTools\SSISDeploy.exe"
          if (-not (Test-Path $ssisDeployPath)) {
            Write-Error "‚ùå SSISDeploy.exe not found at $ssisDeployPath"
            exit 1
          }
          Write-Host "‚úÖ SSISDeploy.exe found at $ssisDeployPath"

      - name: Deploy All .dtsx Packages from Folder to File System
        run: |
          $packageFolder = "HandsOnProjects/Timesheet/TimesheetMigrationProject"
          $targetFolder = "C:\SSISPackages\TimesheetFolder"
          $ssisDeployExe = "C:\SSISDevOpsTools\SSISDeploy.exe"

          # Ensure target folder exists
          if (-not (Test-Path $targetFolder)) {
            Write-Host "Creating target folder: $targetFolder"
            New-Item -Path $targetFolder -ItemType Directory -Force | Out-Null
          }

          Write-Host "üîÑ Deploying all .dtsx packages from '$packageFolder' to '$targetFolder'"

          Get-ChildItem -Path $packageFolder -Filter *.dtsx -Recurse | ForEach-Object {
            $fullPath = $_.FullName
            $packageName = $_.Name
            $destination = "file;$targetFolder"

            Write-Host "‚û°Ô∏è Deploying: $packageName"
            & $ssisDeployExe -source "$fullPath" -destination "$destination"

            if ($LASTEXITCODE -ne 0) {
              Write-Error "‚ùå Failed to deploy $packageName. Exit code: $LASTEXITCODE"
              exit 1
            } else {
              Write-Host "‚úÖ Successfully deployed $packageName"
            }
          }
