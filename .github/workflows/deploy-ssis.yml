name: SSIS Deployment to SSISDB Catalog

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-ssis:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify SSISDB Access
        shell: powershell
        run: |
          $sqlServer = "LAPTOP-7LSAQSR0"
          try {
              $result = sqlcmd -S $sqlServer -d "SSISDB" -Q "SELECT 1 FROM catalog.folders" -E -h -1 -W
              if ($LASTEXITCODE -ne 0) {
                  throw "Failed to query SSISDB catalog"
              }
              Write-Host "Successfully connected to SSISDB catalog using Windows Authentication"
          } catch {
              Write-Error "SSISDB catalog access failed: $_"
              Write-Host "Troubleshooting Steps:"
              Write-Host "1. Verify the runner service is running as WORKGROUP\ErnestMudau"
              Write-Host "2. Confirm ErnestMudau has ssis_admin role (already sysadmin)"
              Write-Host "3. Restart the runner service if changes were made"
              exit 1
          }

      - name: Ensure Timesheet Folder Exists
        shell: powershell
        run: |
          $sqlServer = "LAPTOP-7LSAQSR0"
          $folderName = "TimesheetFolder"
          try {
              $exists = sqlcmd -S $sqlServer -d "SSISDB" -Q "IF EXISTS (SELECT 1 FROM catalog.folders WHERE name = '$folderName') SELECT 1 ELSE SELECT 0" -E -h -1 -W
              if ($exists -eq "0") {
                  Write-Host "Creating folder '$folderName' in SSISDB catalog..."
                  sqlcmd -S $sqlServer -d "SSISDB" -Q "EXEC catalog.create_folder @folder_name = '$folderName'" -E
                  Write-Host "Folder created successfully in SSISDB catalog"
              } else {
                  Write-Host "Folder '$folderName' already exists in SSISDB catalog"
              }
          } catch {
              Write-Error "Failed to create folder in SSISDB catalog: $_"
              exit 1
          }

      - name: Deploy Packages to SSISDB
        shell: powershell
        run: |
          $packagePath = "$env:GITHUB_WORKSPACE\HandsOnProjects\Timesheet\TimesheetMigrationProject"
          $catalogServer = "LAPTOP-7LSAQSR0"
          $folderName = "TimesheetFolder"
          
          if (-not (Test-Path $packagePath)) {
              Write-Error "SSIS project path not found: $packagePath"
              exit 1
          }
          
          Get-ChildItem -Path $packagePath -Filter *.dtsx | ForEach-Object {
              $packageName = $_.BaseName
              Write-Host "Deploying package '$packageName' to SSISDB catalog..."
              $destination = "\SSISDB\$folderName\$packageName"
              & "C:\Program Files\Microsoft SQL Server\160\DTS\Binn\dtutil.exe" /FILE "$($_.FullName)" /DestServer "$catalogServer" /COPY SQL;"$destination"
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "Failed to deploy package '$packageName' to SSISDB catalog"
                  exit $LASTEXITCODE
              }
              Write-Host "Successfully deployed package '$packageName' to SSISDB catalog"
          }
