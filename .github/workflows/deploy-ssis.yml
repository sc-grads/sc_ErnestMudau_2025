name: SSIS Deployment Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'HandsOnProjects/Timesheet/TimesheetMigrationProject/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'HandsOnProjects/Timesheet/TimesheetMigrationProject/**'

jobs:
  deploy-ssis:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Restore NuGet packages
      run: nuget restore HandsOnProjects/Timesheet/TimesheetMigrationProject/TimesheetMigrationProject.sln

    - name: Build SSIS project
      run: msbuild HandsOnProjects/Timesheet/TimesheetMigrationProject/TimesheetMigrationProject.sln /p:Configuration=Release /p:Platform="Any CPU"

    - name: Deploy SSIS project to SQL Server
      run: |
        $ispacPath = "HandsOnProjects/Timesheet/TimesheetMigrationProject/bin/Release/TimesheetMigrationProject.ispac"
        $serverName = "${{ secrets.SQL_SERVER_NAME }}"
        $catalogName = "SSISDB"
        $folderName = "${{ secrets.SSIS_FOLDER_NAME || 'Timesheet' }}"
        $projectName = "TimesheetMigration"
        
        # Check if ISPAC file exists
        if (-not (Test-Path $ispacPath)) {
            Write-Error "ISPAC file not found at $ispacPath"
            exit 1
        }
        
        # Deploy using ISDeploymentWizard
        & "C:\Program Files (x86)\Microsoft SQL Server\140\DTS\Binn\ISDeploymentWizard.exe" `
          /Silent `
          /ModelType:Project `
          /SourcePath:$ispacPath `
          /DestinationServer:$serverName `
          /DestinationPath:"/$catalogName/$folderName/$projectName"
        
        # Verify deployment
        if ($LASTEXITCODE -ne 0) {
            Write-Error "SSIS deployment failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
        }
        
        Write-Output "SSIS package deployed successfully to $serverName/$catalogName/$folderName/$projectName"
        
