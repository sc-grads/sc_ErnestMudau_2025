name: SSIS Deployment Using ISPAC

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-ssis:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Build SSIS Project
        shell: powershell
        run: |
          $solutionPath = "$env:GITHUB_WORKSPACE\HandsOnProjects\Timesheet\TimesheetMigrationProject\TimesheetMigrationProject.sln"
          
          # Restore NuGet packages
          nuget restore $solutionPath
          
          # Build the project
          msbuild $solutionPath /p:Configuration=Release /p:Platform="Any CPU" /p:DeployOnBuild=true
          
          # Verify ISPAC file was created
          $ispacPath = "$env:GITHUB_WORKSPACE\HandsOnProjects\Timesheet\TimesheetMigrationProject\bin\Release\Integration Services Project1.ispac"
          if (-not (Test-Path $ispacPath)) {
              Write-Error "ISPAC file not found at expected location: $ispacPath"
              exit 1
          }
          Write-Host "ISPAC file successfully created at $ispacPath"

      - name: Deploy ISPAC to SSISDB
        shell: powershell
        run: |
          $ispacPath = "$env:GITHUB_WORKSPACE\HandsOnProjects\Timesheet\TimesheetMigrationProject\bin\Release\Integration Services Project1.ispac"
          $sqlServer = "LAPTOP-7LSAQSR0"
          $folderName = "TimesheetFolder"
          $projectName = "TimesheetMigration"
          
          Write-Host "Deploying ISPAC package to SSISDB catalog..."
          
          # Deploy using ISDeploymentWizard (SQL Server 2022 - version 160)
          & "C:\Program Files (x86)\Microsoft SQL Server\160\DTS\Binn\ISDeploymentWizard.exe" `
            /Silent `
            /ModelType:Project `
            /SourcePath:"$ispacPath" `
            /DestinationServer:"$sqlServer" `
            /DestinationPath:"/SSISDB/$folderName/$projectName"
          
          if ($LASTEXITCODE -ne 0) {
              Write-Error "Failed to deploy ISPAC package. Exit code: $LASTEXITCODE"
              exit $LASTEXITCODE
          }
          
          Write-Host "Successfully deployed ISPAC package to SSISDB catalog"

      - name: Verify Deployment
        shell: powershell
        run: |
          $sqlServer = "LAPTOP-7LSAQSR0"
          $folderName = "TimesheetFolder"
          $projectName = "TimesheetMigration"
          
          $result = sqlcmd -S $sqlServer -d "SSISDB" -Q "SELECT 1 FROM catalog.projects WHERE name = '$projectName' AND folder_id = (SELECT folder_id FROM catalog.folders WHERE name = '$folderName')" -E -h -1 -W
          
          if ([string]::IsNullOrEmpty($result)) {
              Write-Error "Deployment verification failed - project not found in SSISDB catalog"
              exit 1
          }
          
          Write-Host "Deployment verified successfully in SSISDB catalog"
