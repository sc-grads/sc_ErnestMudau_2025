name: Deploy SQL Agent Jobs

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install sqlcmd with diagnostics
        run: |
          try {
            Write-Host "Attempting to download sqlcmd.zip from https://aka.ms/download-sqlcmd"
            Invoke-WebRequest -Uri "https://aka.ms/download-sqlcmd" -OutFile "sqlcmd.zip" -ErrorAction Stop
            Write-Host "Download successful. Extracting sqlcmd.zip..."
            Expand-Archive -Path sqlcmd.zip -DestinationPath "C:\sqlcmd" -ErrorAction Stop
            Write-Host "Extraction complete. Adding C:\sqlcmd to PATH..."
            echo "C:\sqlcmd" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "sqlcmd installation completed."
          } catch {
            Write-Host "Error occurred: $_"
            exit 1
          }

      - name: Deploy All SQL Agent Jobs
        env:
          SQL_SERVER: ${{ secrets.TIMESHEETDB_SQL_SERVER_PUBLIC_URL }}
          SQL_USER: ${{ secrets.TIMESHEETDB_SQL_USER }}
          SQL_PASSWORD: ${{ secrets.TIMESHEETDB_SQL_PASSWORD }}
        run: |
          sqlcmd -S "$env:SQL_SERVER" -U "$env:SQL_USER" -P "$env:SQL_PASSWORD" -d msdb -i "HandsOnProjects/Timesheet/sql scripts/DeployAllJobs.sql"
